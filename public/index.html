<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Bae & Ultimate 운항보조프로그램</title>
    <style>
      body,
      h1,
      a,
      button {
        margin: 0;
        padding: 0;
        font-family: Arial, sans-serif;
      }

      body {
        display: flex;
        height: 100vh;
        overflow: hidden;
        background-color: #1a1a1a;
      }

      .sidebar {
        width: 180px;
        background-color: #333;
        color: white;
        display: flex;
        flex-direction: column;
        align-items: center;
        padding-top: 20px;
        padding-left: 10px;
        position: relative;
      }

      .logo {
        width: 160px;
        height: 160px;
        cursor: pointer;
        background-image: url("/assets/sidebar/logo.svg");
        background-size: contain;
        background-repeat: no-repeat;
        background-position: center;
        margin-bottom: 20px;
        animation: rotate 15s linear infinite;
      }

      @keyframes rotate {
        from {
          transform: rotate(360deg);
        }
        to {
          transform: rotate(0deg);
        }
      }

      .menu {
        display: flex;
        flex-direction: column;
        align-items: center;
        width: 100%;
      }

      .menu a {
        width: 100%;
        padding: 30px;
        margin: 5px 0;
        background-color: transparent;
        color: white;
        text-align: center;
        text-decoration: none;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .menu a:hover {
        background-color: #555;
      }

      .menu img {
        width: 24px;
        height: 24px;
      }

      .ulsanlogo {
        width: 200px;
        height: 100px;
        cursor: pointer;
        background-image: url("/assets/sidebar/ulsanlogo.svg");
        background-size: contain;
        background-repeat: no-repeat;
        background-position: center;
        margin-top: 20px;
      }

      .container {
        display: flex;
        flex-grow: 1;
        padding: 20px;
        color: white;
      }

      .camera-feed {
        flex: 2;
        background-color: #000;
        margin-right: 20px;
        position: relative;
      }

      .camera-feed canvas {
        width: 640px;
        height: 480px;
      }

      .compass {
        position: absolute;
        top: 20px;
        right: 0%;
        transform: translateX(-50%);
        width: 331px;
        height: 470.59px;
      }

      .compass2 {
        width: 100%;
        height: 100%;
        background-image: url("assets/compass/compass2.svg");
        background-size: cover;
      }

      .compass1 {
        left: 100%;
        bottom: 175px;
        position: absolute;
        width: 292.06px;
        height: 292.06px;
        background-image: url("assets/compass/compass1.svg");
        background-size: cover;
        transform: translateX(-100%) translateY(12%) rotate(0deg);
        z-index: 1;
        transition: transform 0.5s;
      }

      .real,
      .disire {
        font-family: "Ubuntu", sans-serif;
        font-size: 20pt;
        position: absolute;
        z-index: 2;
      }

      .real {
        color: orange;
        top: 390px;
        left: 210px;
      }

      .disire {
        color: blue;
        top: 440px;
        left: 215px;
      }

      .indicators {
        flex: 1;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
        background-color: #222;
        padding: 10px;
      }

      .indicator {
        background-color: #444;
        padding: 10px;
        border-radius: 8px;
        margin-bottom: 10px;
        display: flex;
        align-items: center;
      }

      .indicator img {
        margin-right: 10px;
      }
    </style>
  </head>

  <body>
    <div class="sidebar">
      <div class="logo"></div>
      <div class="menu">
        <a href="./localization.html">
          <img src="./assets/sidebar/local.svg" alt="icon1" />Localization
        </a>
        <a href="./perception.html">
          <img src="./assets/sidebar/perce.svg" alt="icon2" />Perception
        </a>
        <a href="./decision.html">
          <img src="./assets/sidebar/decis.svg" alt="icon3" />Decision
        </a>
        <a href="./control.html">
          <img src="./assets/sidebar/contr.svg" alt="icon4" />Control
        </a>
      </div>
      <div class="ulsanlogo"></div>
    </div>

    <div class="container">
      <div class="camera-feed">
        <canvas id="ros-canvas"></canvas>
        <div class="compass">
          <div class="compass2"></div>
          <div class="compass1"></div>
          <h1 class="real">0°</h1>
          <h1 class="disire">100°</h1>
        </div>
      </div>
      <!-- <div class="indicators">
        <div class="indicator">
          <img src="/assets/icons/gps.svg" alt="gps" />
          <div>GPS: CONNECTED</div>
        </div>
        <div class="indicator">
          <img src="/assets/icons/imu.svg" alt="imu" />
          <div>IMU: CONNECTED</div>
        </div>
        <div class="indicator">
          <img src="/assets/icons/other.svg" alt="other" />
          <div>NTRIP: CONNECTED</div>
        </div>
      </div> -->
    </div>

    <script type="text/javascript" src="roslib.min.js"></script>
    <script>
      async function loadSidebar() {
        try {
          const ros = new ROSLIB.Ros({
            url: "ws://192.168.10.126:9090",
          });

          const canvas = document.getElementById("ros-canvas");
          const ctx = canvas.getContext("2d");

          const imageListener = new ROSLIB.Topic({
            ros: ros,
            name: "/usb_cam/image_raw/compressed",
            messageType: "sensor_msgs/CompressedImage",
          });

          imageListener.subscribe(function (message) {
            const imageData = message.data;
            const blob = b64toBlob(imageData, "image/jpeg");
            const img = new Image();
            img.onload = function () {
              canvas.width = img.width;
              canvas.height = img.height;
              ctx.drawImage(img, 0, 0, img.width, img.height);
            };
            img.src = URL.createObjectURL(blob);
          });
        } catch (error) {
          console.error("Error loading sidebar:", error);
        }
      }

      window.onload = loadSidebar;

      function b64toBlob(b64Data, contentType = "", sliceSize = 512) {
        const byteCharacters = atob(b64Data);
        const byteArrays = [];
        for (
          let offset = 0;
          offset < byteCharacters.length;
          offset += sliceSize
        ) {
          const slice = byteCharacters.slice(offset, offset + sliceSize);
          const byteNumbers = new Array(slice.length);
          for (let i = 0; i < slice.length; i++) {
            byteNumbers[i] = slice.charCodeAt(i);
          }
          const byteArray = new Uint8Array(byteNumbers);
          byteArrays.push(byteArray);
        }
        const blob = new Blob(byteArrays, { type: contentType });
        return blob;
      }

      const disireDeg = 100;
      const compass1 = document.querySelector(".compass1");
      const realHeading = document.querySelector(".real");

      async function fetchHeading() {
        try {
          const response = await fetch("/utm_XYH");
          const data = await response.json();
          if (data && data.heading !== undefined) {
            const realDeg = data.heading;
            compass1.style.transform = `translateX(-100%) translateY(12%) rotate(${realDeg}deg)`;
            realHeading.textContent = `${realDeg}도`;
          }
        } catch (error) {
          console.error("Error fetching UTM data:", error);
        }
      }

      fetchHeading();
      setInterval(fetchHeading, 1000);
    </script>
  </body>
</html>
